{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
  <h2 class="mb-4">Upload Candidate PDFs</h2>

  <div id="flashMessage" class="alert alert-success d-none" role="alert">Files uploaded successfully!</div>
  <div id="fileUploadArea" class="border rounded p-4 text-center mb-4">
    <p>Drag & drop files here or click to select</p>
    <input type="file" id="fileElem" accept=".pdf" name="file" style="display:none">
    <label for="fileElem" class="btn btn-primary mb-3">Select Files</label>
    <div id="selectedFilesList" class="mt-3"></div>
    <button type="button" class="btn btn-success mt-2 d-none" id="uploadBtn">Upload Selected Files</button>
  </div>

  <div id="uploadResults"></div>

  <!-- CSRF -->
  <form id="csrfTokenForm" style="display:none;">
    {% csrf_token %}
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const uploadArea = document.getElementById("fileUploadArea");

    function setupFileInput() {
      const fileElem = document.getElementById("fileElem");
      if (!fileElem) return;

      fileElem.addEventListener("change", function () {
        const selectedFile = fileElem.files[0];
        if (!selectedFile) return;

        if (!selectedFile.name.toLowerCase().endsWith(".pdf")) {
          alert("Only PDF files are allowed.");
          return;
        }

        // Visa laddare direkt
        uploadArea.innerHTML = `
          <div class="text-center py-4">
            <img src="/static/media/images/selekt-loading.gif" alt="Loading..." style="width: 70px;">
            <p class="mt-3 fw-bold">Please wait while we scan your PDF for candidate details...</p>
          </div>
        `;

        const formData = new FormData();
        formData.append("file", selectedFile);

        fetch("/candidates/upload/", {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
          },
          body: formData,
        })
        .then(res => res.json())
        .then(data => {
          if (data.results && data.results[0].status === "success" && data.results[0].structured) {
            return fetch("/candidates/create-from-openai/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
              },
              body: JSON.stringify(data.results[0].structured)
            });
          } else {
            const errMsg = data.results && data.results[0].error
              ? data.results[0].error
              : "No structured data returned from OpenAI";
            throw new Error(errMsg);
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.redirect_url) {
            window.location.href = data.redirect_url;
          }
        })
        .catch(err => {
          console.error("Upload or parsing failed:", err);
          uploadArea.innerHTML = `
            <div class="alert alert-danger text-center p-4">
              ‚ùå <strong>Something went wrong:</strong><br>
              ${err.message}<br>
              Please try uploading a different PDF file.
            </div>
            <div class="text-center mt-3">
              <label for="fileElem" class="btn btn-primary">Choose a new file</label>
              <input type="file" id="fileElem" name="file" style="display:none">
            </div>
          `;
          setupFileInput(); // Re-bind event to new file input
        });
      });
    }

    setupFileInput(); // Initial bind on page load
  });
</script>


{% endblock %}